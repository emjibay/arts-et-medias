{% extends "layouts/pieceDetailsLayout.njk" %}


{%- from 'macros/banner-ad.njk' import inContextLeaderboard, mobileBannerAds -%}
{%- from 'macros/content-section.njk' import contentSection -%}
{%- from 'macros/cta.njk' import externalCTA -%}
{%- from 'macros/hero-image.njk' import heroImage -%}
{%- from 'macros/metadata.njk' import articleMetaData -%}
{%- from 'macros/piece-details.njk' import relatedAcademicPrograms, relatedEvents, relatedMedia, relatedOrganizations, relatedPieces, tags -%}
{%- from 'macros/piece-link-list.njk' import pieceLinkList -%}


{%- set locale = apos.aemI18n.getSanitizedLocale(data) -%}
{%- set piece = data.piece -%}
{%- set mainLBOptions = { data: data, propName: 'articlesLeaderboard' } -%}
{%- set minorLBOptions = { data: data, propName: 'articlesMinorLeaderboard' } -%}
{%- set isMainLBVisible = apos.aemBannerAds.areVisible(mainLBOptions) -%}
{%- set isMinorLBVisible = apos.aemBannerAds.areVisible(minorLBOptions) -%}
{%- set bannerPropNames = ['articlesSidebarBanners1', 'articlesSidebarBanners2', 'articlesSidebarBanners3'] -%}


{% block title %}
  {{
    apos.aemSeo.buildPieceWithCategory(
      __,
      piece.title,
      __('articles|plural'),
      data.page.title
    )
  }}
{% endblock %}

{% block metadata %}
  {%- set author = apos.aemAuthors.getListFromArticle(piece) -%}
  {{
    articleMetaData({
      title: piece.title,
      authors: apos.aemAuthors.getArrayFromArticle(piece),
      publicationDate: apos.aemPieces.getISODate(piece),
      description: piece.shortDescription,
      heroImage: piece.heroImage,
      section: apos.aemPieces.getArticleSection(__, piece),
      url: piece._url,
      baseUrl: apos.aemUtils.ensureHTTPS(data.baseUrl),
      tags: piece.tags,
      locale: locale
    })
  }}
{% endblock %}

{% block mainAdditionalClasses %}article-details{% endblock %}

{% block subheading %}
  <div class="subheading">
    <h2 class="sr-only">{{ __('pieceDetails|authorsLabel') }}</h2>
    {{ pieceLinkList(piece._originalAuthor) }}, {{ apos.aemDates.format(piece.publicationDate, locale) }}
  </div>
{% endblock %}

{% block advertisementBeforeMain %}
  {%- if isMainLBVisible -%}
    {{ inContextLeaderboard(mainLBOptions, { location: 'before' }) }}
  {%- endif -%}
{% endblock %}

{% block pageContent %}
  {%- set bannerIndex = 0 -%}

  {{
    heroImage(
      piece,
      true,
      apos.aemUtils.isDraftMode(data)
    )
  }}

  <div class="description rich-description">
    {{ contentSection(piece) }}
  </div>

  {%- if bannerIndex < bannerPropNames|length -%}
    {{
      mobileBannerAds({
        data: data,
        propName: bannerPropNames[bannerIndex]
      })
    }}
    {%- set bannerIndex = bannerIndex + 1 -%}
  {%- endif -%}

  {%- set isMention = piece.articleType === 'mention' -%}
  {%- if isMention -%}
    <div class="mention">
      {{
        externalCTA({
          label: __('articles|readFullArticle'),
          ariaLabel: __('articles|readFullArticle') + ' - ' + piece.title,
          url: piece.externalLink
        })
      }}
      <p class="mention-notes">{{ __('articles|notOriginallyPublishedHere') }}</p>
    </div>
  {%- endif -%}

  {%- if isMinorLBVisible -%}
    {{ inContextLeaderboard(minorLBOptions, {}) }}
  {%- endif -%}

  <hr class="separator"/>

  <dl class="piece-props-list">
    {%-
      set isSameLocale = apos.aemI18n.isSameLocale(
        piece.originalLang,
        locale,
        { emptyAsTrue: true }
      )
    -%}
    {%- if not isSameLocale -%}
      <dt>{{ __('pieceDetails|originalLanguageLabel') }}</dt>
      {%- set originalLang = apos.aemI18n.getLanguagesFrom(piece.originalLang, locale) -%}
      <dd>{{ originalLang }}</dd>
    {%- endif -%}

    {%- if piece.isTranslation -%}
      <dt>{{ __('pieceDetails|translatorLabel') }}</dt>
      <dd>{{ pieceLinkList(piece._translator) }}</dd>
    {%- endif -%}
  </dl>

  {# projets #}
  {{ relatedPieces(__('projects|related'), piece._relatedProjects) }}

  {# articles #}
  {%- set relatedArticles = apos.aemArrays.merge(piece._relatedArticles, piece._articles) -%}
  {{ relatedPieces(__('articles|related'), relatedArticles) }}

  {# books #}
  {{ relatedPieces(__('books|related'), piece._relatedBooks) }}

  {# media #}
  {{ relatedMedia(piece._relatedMedia) }}

  {# events #}
  {{ relatedEvents(piece._relatedEvents) }}

  {# people #}
  {{ relatedPieces(__('people|related'), piece._relatedPeople) }}

  {# organizations #}
  {{ relatedOrganizations(piece._relatedOrganizations) }}

  {# academic programs #}
  {{ relatedAcademicPrograms(piece._relatedEducation, { i18n: __ }) }}

  {# tags #}
  {{ tags(piece) }}

  {%- if bannerIndex < bannerPropNames|length -%}
    {{
      mobileBannerAds({
        data: data,
        propName: bannerPropNames[bannerIndex]
      })
    }}
    {%- set bannerIndex = bannerIndex + 1 -%}
  {%- endif -%}

  {%- if piece.hasCitations and piece.citations -%}
    <hr class="separator"/>
    {%- include 'partials/articles/citations-section.njk' -%}
  {%- endif -%}

  {%- if bannerIndex < bannerPropNames|length -%}
    {{
      mobileBannerAds({
        data: data,
        propName: bannerPropNames[bannerIndex]
      })
    }}
  {%- endif -%}

  {%- if isMainLBVisible -%}
    {{ inContextLeaderboard(mainLBOptions, { location: 'after' }) }}
  {%- endif -%}
{% endblock %}

{% block sidebar %}
  {% include "partials/articles/sidebar.njk" %}
{% endblock %}
