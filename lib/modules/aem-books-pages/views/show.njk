{% extends "layouts/pieceDetailsLayout.njk" %}

{%- from 'macros/metadata.njk' import bookMetaData -%}
{%- from 'macros/piece-details.njk' import relatedContent, relatedMedia, relatedOrganizations, relatedPieces, tags, websiteCTA -%}
{%- from 'macros/piece-link-list.njk' import authorsLinkList, pieceLinkList -%}
{%- from 'options/options.njk' import fixedRichTextOptions -%}


{%- set piece = data.piece -%}


{% block title %}
  {{
    apos.aemSeo.buildPieceWithType(
      __,
      piece.title,
      __('books|heading')
    )
  }}
{% endblock %}

{% block metadata %}
  {{
    bookMetaData({
      title: piece.title,
      authors: apos.aemAuthors.getArrayFromPiece(piece),
      description: piece.shortDescription,
      yearPublished: piece.yearPublished,
      heroImage: piece.heroImage,
      url: piece._url,
      baseUrl: apos.aemUtils.ensureHTTPS(data.baseUrl),
      tags: piece.tags
    })
  }}
{% endblock %}

{% block main %}
  <div class="piece-details book-details">
    <div class="content">
      <main id="main">
        <article>
          {% include "partials/components/breadcrumbs.njk" %}

          <h1 class="h1">
            <span>{{ piece.title }}</span>
            {%- if piece.subtitle -%}
              <br>
              <p class="book-subtitle">{{ piece.subtitle }}</p>
            {%- endif -%}
          </h1>

          <div class="subheading">
            <h2 class="sr-only">{{ __('pieceDetails|authorsLabel') }}</h2>
            {{
              authorsLinkList(
                piece._author,
                piece._editor,
                __('books|editorAbbreviation')
              )
            }}
          </div>

          <div class="page-content">
            {% block pageContent %}
              {# image start #}
              {%- set aposImageData = apos.images.first(piece.heroImage) -%}
              {%- if aposImageData -%}
                {%- set image = apos.aemUtils.getImageBasicData(aposImageData) -%}
                <img
                  class="book-cover"
                  src="{{ image.url }}"
                  alt="{{ image.alt }}"
                />
              {%- endif -%}
              {# image end #}

              <h2 class="sr-only">{{ __('pieceDetails|descriptionLabel') }}</h2>
              <div class="description rich-description">
                {{
                  apos.singleton(
                    piece,
                    'description',
                    'apostrophe-rich-text',
                    fixedRichTextOptions
                  )
                }}
              </div>

              {{ websiteCTA(piece) }}
            {% endblock %}

            <div class="page-content">
              <hr class="separator"/>

              <dl class="piece-props-list">
                {%- if piece._contributor|length >Â 0 -%}
                  <dt>{{ __('pieceDetails|contributorsLabel') }}</dt>
                  <dd>{{ pieceLinkList(piece._contributor) }}</dd>
                {%- endif -%}

                <dt>{{ __('pieceDetails|yearPublishedLabel') }}</dt>
                <dd>{{ piece.yearPublished }}</dd>

                {%- set locale = apos.aemI18n.getSanitizedLocale(data) -%}
                {%- set langs = apos.aemI18n.getLanguagesFrom(piece.lang, locale) -%}
                {%- if langs|length > 1 -%}
                  <dt>{{ __('pieceDetails|languagesLabel') }}</dt>
                  <dd>
                    <p>
                      {% for lang in langs %}
                        <span>{{ lang }}</span>
                        {%- if not loop.last -%}
                          <span>, </span>
                        {%- endif -%}
                      {% endfor %}
                    </p>
                  </dd>
                {%- else -%}
                  <dt>{{ __('pieceDetails|languageLabel') }}</dt>
                  <dd>{{ langs[0] }}</dd>
                {%- endif -%}

                {%- if piece.isTranslation -%}
                  <dt>{{ __('pieceDetails|originalLanguageLabel') }}</dt>
                  {%- set originalLang = apos.aemI18n.getLanguage(piece.originalLang, locale) -%}
                  <dd>{{ originalLang }}</dd>

                  <dt>{{ __('pieceDetails|translatorLabel') }}</dt>
                  <dd>{{ pieceLinkList(piece._translator) }}</dd>
                {%- endif -%}
              </dl>

              {{ relatedPieces(__('articles|related'), piece._relatedArticles) }}

              {%- set relatedBooks = apos.aemArrays.merge(piece._relatedBooks, piece._booksMentioned) -%}
              {{ relatedPieces(__('books|related'), relatedBooks) }}

              {{ relatedPieces(__('people|related'), piece._relatedPeople) }}

              {{ relatedOrganizations(piece._relatedOrganizations) }}

              {{ relatedMedia(piece._relatedMedia) }}

              {{ tags(piece) }}

              <hr class="separator"/>

              <div class="citations">
                <h2 class="citation-heading">{{ __('books|citations|heading') }}</h2>
                <p>{{ __('books|citations|warning') }}</p>

                <dl class="citation-list">
                  {%- set citations = data.bookCitations -%}
                  {%-
                    set options = {
                      piece: piece,
                      citations: citations,
                      locale: locale
                    }
                  -%}

                  <dt>{{ __('books|citations|styles|mla') }}</dt>
                  <dd>
                    {%- set mlaCitation = apos.aemBooks.getMLA(piece, citations) -%}
                    {{ mlaCitation | safe }}
                  </dd>

                  <dt>{{ __('books|citations|styles|chicago') }}</dt>
                  <dd>
                    {%- set chicagoCitation = apos.aemBooks.getChicago(piece, citations, locale) -%}
                    {{ chicagoCitation | safe }}
                  </dd>

                  <dt>{{ __('books|citations|styles|apa') }}</dt>
                  <dd>
                    {%- set apaCitation = apos.aemBooks.getAPA(piece, citations, locale) -%}
                    {{ apaCitation | safe }}
                  </dd>

                  <dt>{{ __('books|citations|styles|bibtex') }}</dt>
                  {%- set bibtexCitation = apos.aemBooks.getBibTex(piece, citations, locale) -%}
                  <dd class="bibtex">{{ bibtexCitation }}</dd>
                </dl>
              </div>
            </div>
          </div>

          {% block sidebar %}
            {% include "partials/books/sidebar-details-en.njk" %}
          {% endblock %}
        </article>
      </main>
    </div>
  </div>
{% endblock %}
