{%- from 'macros/piece-link-list.njk' import sortedPieceLinkList -%}
{%- from 'macros/tag-list.njk' import tagList -%}


{%- macro truncatedDescription(piece, options) -%}
  {%- if options.length -%}
    {%- set truncLength = options.length -%}
  {%- else -%}
    {%- set truncLength = 140 -%}
  {%- endif -%}


  {%- if piece.shortDescription -%}
    {%- set descriptionText = piece.shortDescription -%}
    {%- if options.alwaysTruncate -%}
      {%- set descriptionText = descriptionText | truncate(truncLength, true, "...") -%}
    {%- endif -%}
    <p>{{ descriptionText }}</p>

  {%- elseif piece.description.items -%}
    {%- set descriptionText = piece.description.items[0].content | safe -%}
    {%- set descriptionText = descriptionText | truncate(truncLength, true, "...") -%}
    {{ descriptionText }}

  {%- else -%}
    {%- set descriptionText = piece.description -%}
    {%- set descriptionText = descriptionText | truncate(truncLength, true, "...") -%}
    {{ descriptionText }}
  {%- endif -%}
{%- endmacro -%}

{%- macro websiteCTA(piece) -%}
  {%- if piece.website -%}
    <a
      class="website-cta"
      href="{{ piece.website }}"
      target="_blank"
      rel="noopener noreferrer"
    >View website</a>
  {%- endif -%}
{%- endmacro -%}

{% macro relatedPieces(label, pieces) %}
  {%- if pieces|length -%}
    <dl class="piece-props-list">
      <dt>{{ label }}</dt>
      <dd>{{ sortedPieceLinkList(pieces) }}</dd>
    </dl>
  {%- endif -%}
{% endmacro %}

{% macro relatedOrganizations(organizations) %}
  {# collectives #}
  {{
    relatedTaggedPieces(
      'Related Collectives and Studios',
      organizations,
      ['collective','studio']
    )
  }}

  {# galleries #}
  {{
    relatedTaggedPieces(
      'Related Galleries',
      organizations,
      ['gallery', 'museum']
    )
  }}

  {# art centers #}
  {{
    relatedTaggedPieces(
      'Related Art Centers',
      organizations,
      ['art center']
    )
  }}

  {# academic institutions #}
  {{
    relatedTaggedPieces(
      'Related Academic Institutions',
      organizations,
      [
        'academic institution',
        'higher education',
        'university'
      ]
    )
  }}

  {# media labs #}
  {{
    relatedTaggedPieces(
      'Related Media Labs and Research Centers',
      organizations,
      [
        'media lab',
        'archives',
        'art research',
        'research',
        'research-creation'
      ]
    )
  }}

  {# other #}
  {%-
    set otherOrgs = apos.aemPieces.getWithoutTags(
      organizations,
      [
        'collective',
        'studio',
        'gallery',
        'museum',
        'art center',
        'academic institution',
        'higher education',
        'university',
        'media lab',
        'archives',
        'art research',
        'research',
        'research-creation'
      ]
    )
  -%}
  {{ relatedPieces('Related Organizations', otherOrgs) }}
{% endmacro %}

{% macro relatedContent(piece) %}
  {{ relatedPieces('Related Articles', piece._relatedArticles) }}

  {{ relatedPieces('Related Books', piece._relatedBooks) }}

  {{ relatedPieces('Related People', piece._relatedPeople) }}

  {{ relatedOrganizations(piece._relatedOrganizations) }}

  {{ relatedPieces('Related Media', piece._relatedMedia) }}
{% endmacro %}

{% macro relatedTaggedPieces(label, pieces, tags) %}
  {%-
    set filteredPieces = apos.aemPieces.getWithTags(
      pieces,
      tags
    )
  -%}
  {{ relatedPieces(label, filteredPieces) }}
{% endmacro %}

{% macro tags(piece) %}
  {%- set hasTags = piece.tags|length > 0 -%}
  {%- if hasTags -%}
    <dl class="piece-props-list">
      <dt>Topics</dt>
      <dd>{{ tagList(piece.tags) }}</dd>
    </dl>
  {%- endif -%}
{% endmacro %}
